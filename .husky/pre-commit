set -e

# Go to root directory of the repository
cd "$(git rev-parse --show-toplevel)"

# Run frontend lint-staged
echo "üõ†Ô∏è- Running linting and formatting checks..."
cd ./frontend
npx lint-staged

# Run backend pre-commit linting
cd ../backend
uv run pre-commit run --config .pre-commit-config.yaml --hook-stage pre-commit

echo "‚úÖ- Linting and formatting checks passed"

# Run Alembic checks if model or migration files changed
if git diff --cached --name-only | grep -qE "(models\.py|models/|alembic/versions/)"; then
    echo "üóÉÔ∏è- Checking database migrations and models..."

    if ! uv run alembic current >/dev/null 2>&1; then
        echo "‚ùå- Cannot connect to database! Make sure your database is running."
        exit 1
    fi

    if ! uv run alembic upgrade head >/dev/null 2>&1; then
        echo "‚ùå- Failed to upgrade to latest migration. One of your migration(s) has a broken upgrade() function."
        exit 1
    fi

    if ! uv run alembic check; then
        echo "‚ùå- Models don't match database after running latest migrations. This means either:"
        echo "   - You changed models but didn't create a migration script"
        echo "   - Your latest migration script doesn't actually reflect your current models"
        exit 1
    fi

    echo "‚úÖ Checks for database migrations and models passed"
fi