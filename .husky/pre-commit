set -e

# Go to root directory of the repository
cd "$(git rev-parse --show-toplevel)"

# Run frontend lint-staged
echo "🛠️- Running linting and formatting checks..."
cd ./frontend
npx lint-staged

# Run backend pre-commit linting
cd ../backend
uv run pre-commit run --config .pre-commit-config.yaml --hook-stage pre-commit

echo "✅- Linting and formatting checks passed"

# Run alembic checks
if git diff --cached --name-only | grep -qE "(models\.py|models/|alembic/versions/)"; then
    echo "🛠️- Running test-migrations docker container ..."

    CONTAINER_ID=$(docker compose run --build -d test-migrations | tail -n1)
    EXIT_CODE=$(docker wait "$CONTAINER_ID")

    if [ "$EXIT_CODE" -eq 0 ]; then
        docker rm "$CONTAINER_ID" >/dev/null 2>&1
        echo "✅- Database migration and model checks passed"
    else
        echo "❌- Initializing the database, and checking migrations and models failed. Check the logs:"
        docker logs $CONTAINER_ID
        docker rm "$CONTAINER_ID" >/dev/null 2>&1
        exit 1
    fi
fi
